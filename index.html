<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Staff Sign In / Out</title>
  <meta name="theme-color" content="#10b981">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Sign In/Out">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script>
    // ===== Compatibility / Polyfills =====
    (function(){
      try {
        if (!window.crypto) window.crypto = window.msCrypto || {};
        if (!('getRandomValues' in crypto)) {
          crypto.getRandomValues = function (arr) {
            for (var i=0;i<arr.length;i++) arr[i] = Math.floor(Math.random()*256);
            return arr;
          };
        }
        if (!('randomUUID' in crypto)) {
          crypto.randomUUID = function () {
            var bytes = new Uint8Array(16);
            crypto.getRandomValues(bytes);
            bytes[6] = (bytes[6] & 0x0f) | 0x40;
            bytes[8] = (bytes[8] & 0x3f) | 0x80;
            var toHex = function(b){ return ('0' + b.toString(16)).slice(-2); };
            var s = Array.from(bytes, toHex).join('');
            return s.slice(0,8)+'-'+s.slice(8,12)+'-'+s.slice(12,16)+'-'+s.slice(16,20)+'-'+s.slice(20);
          };
        }
      } catch(e){ /* no-op */ }
    })();
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { -webkit-tap-highlight-color: transparent; }
    button { touch-action: manipulation; }
    input, select, textarea { font-size: 16px; }
    @media print {
      header, footer, .no-print, .hide-on-print { display:none !important }
      #printable-report, #printable-individual { display:block !important }
      table { font-size: 11px }
      body { background: white }
    }
  </style>
</head>
<body class="antialiased bg-slate-50 text-slate-900">
  <div id="root"></div>
  <div id="err" class="hidden fixed top-2 left-1/2 -translate-x-1/2 bg-red-600 text-white text-sm px-3 py-2 rounded-xl shadow"></div>
  <script>
    window.onerror = function(msg, src, line, col, err){
      try {
        var el = document.getElementById('err');
        el.textContent = 'Error: ' + msg;
        el.classList.remove('hidden');
      } catch(e){}
      return false;
    };
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
  <script>
    const { useEffect, useMemo, useRef, useState } = React;

    function App(){
      // --- Storage helpers ---
      const loadLS = (k, fb) => { try{ const v = localStorage.getItem(k); return v? JSON.parse(v): fb; }catch{ return fb; } };
      const saveLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));
      const migrateStaff = (s) => Array.isArray(s) && s.length ? (typeof s[0]==='string' ? s.map(n=>({name:n, pin:''})) : s.map(x=>({name:x.name, pin:x.pin||''}))) : [];

      // --- State ---
      const [staff, setStaff] = useState(()=> migrateStaff(loadLS('signio_staff', ['CJ An','Emily','Ebony','Charlotte','Reegan','Holly'])));
      const [records, setRecords] = useState(()=> loadLS('signio_records', []));
      const [audit, setAudit] = useState(()=> loadLS('signio_audit', []));
      const [overrides, setOverrides] = useState(()=> loadLS('signio_overrides', {})); // key: `${name}|YYYY-MM-DD` -> hours number
      const [settings, setSettings] = useState(()=> loadLS('signio_settings', { timezone:'Australia/Sydney', show24h:true, compactRows:false, requirePIN:true, autoMidnightOut:true, requireEditReason:false }));
      const [selected, setSelected] = useState('');
      const [filter, setFilter] = useState('');
      const adminOptions = ['CJ An','Emily'];
      const [admin, setAdmin] = useState({enabled:false, by:''});
      const [confirmClear, setConfirmClear] = useState(false);

      // Reports state
      const [dailyDate, setDailyDate] = useState(()=> todayLocalISO());
      const [rangeStart, setRangeStart] = useState(()=> todayLocalISO());
      const [rangeEnd, setRangeEnd] = useState(()=> todayLocalISO());
      const [report, setReport] = useState({ rows: [], perDay: [], start: '', end: '' });

      // Individual detail report
      const [person, setPerson] = useState('');
      const [indivRows, setIndivRows] = useState([]);
      const [indivTotal, setIndivTotal] = useState(0);

      useEffect(()=> saveLS('signio_staff', staff), [staff]);
      useEffect(()=> saveLS('signio_records', records), [records]);
      useEffect(()=> saveLS('signio_audit', audit), [audit]);
      useEffect(()=> saveLS('signio_settings', settings), [settings]);
      useEffect(()=> saveLS('signio_overrides', overrides), [overrides]);

      // --- Time helpers ---
      const dateFmt = useMemo(()=> new Intl.DateTimeFormat('en-CA', {timeZone:settings.timezone, year:'numeric', month:'2-digit', day:'2-digit'}), [settings.timezone]);
      const fmt = useMemo(()=> new Intl.DateTimeFormat('en-AU', {timeZone:settings.timezone, year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:!settings.show24h}), [settings.timezone, settings.show24h]);
      const formatTs = (ts)=> fmt.format(new Date(ts));
      const dayKey = (ts)=> dateFmt.format(new Date(ts));
      const todayKey = ()=> dayKey(Date.now());
      const [lastDayKey, setLastDayKey] = useState(todayKey());
      function localEndOfDay(ts){ const d = new Date(ts); d.setHours(23,59,59,999); return d.getTime(); }
      function todayLocalISO(){ const d = new Date(); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); return d.toISOString().slice(0,10); }

      // --- Derived ---
      const visibleStaff = useMemo(()=> staff.filter(s=> s.name.toLowerCase().includes(filter.toLowerCase())), [staff, filter]);
      const lastActionFor = (name)=> { for(let i=records.length-1;i>=0;i--){ if(records[i].name===name) return {action:records[i].action, ts:records[i].ts}; } return null; };
      const currentlyIn = useMemo(()=> {
        const map = new Map(); for(const r of records) map.set(r.name, r.action);
        return staff.filter(s=> map.get(s.name)==='IN').map(s=>s.name).sort((a,b)=>a.localeCompare(b));
      }, [records, staff]);

      // --- Actions ---
      const addRecordInternal = (name, action, ts = Date.now()) => {
        const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+'_'+Math.random();
        const rec = { id, name, action, ts, tz: settings.timezone };
        setRecords(r=> [...r, rec]);
        return rec;
      };

      // Auto midnight OUT
      useEffect(()=>{
        try{
          const closeStale = (limit)=>{
            const lastMap = new Map(); for(const r of records) lastMap.set(r.name, {action:r.action, ts:r.ts});
            const actions = [];
            for(const s of staff){
              const la = lastMap.get(s.name);
              if(!la) continue;
              if(la.action==='IN'){
                const dk = dayKey(la.ts);
                const today = todayKey();
                const isStale = dk !== today && (!limit || dk === limit);
                if(isStale) actions.push(s.name);
              }
            }
            if(actions.length){
              const now = Date.now();
              setRecords(r=> [...r, ...actions.map(n=>({id:(crypto.randomUUID?crypto.randomUUID():String(now)+'_'+Math.random()), name:n, action:'OUT', ts:now, tz:settings.timezone}))]);
              setAudit(a=> [...a, ...actions.map(n=>({id:(crypto.randomUUID?crypto.randomUUID():String(now)+'_'+Math.random()), when:now, editor:'SYSTEM', type:'ADD_BACKDATED_OUT', targetName:n, reason:'Auto midnight sign-out'}))]);
            }
          };
          if(settings.autoMidnightOut) closeStale();
          const id = setInterval(()=>{
            const tk = todayKey();
            if(tk !== lastDayKey){
              if(settings.autoMidnightOut) closeStale(lastDayKey);
              setLastDayKey(tk);
            }
          }, 60000);
          return ()=> clearInterval(id);
        }catch(e){ console.error(e); }
      }, [records.length, settings.timezone, settings.autoMidnightOut, lastDayKey]);

      const promptPIN = (who) => window.prompt('Enter PIN for '+who+' (leave blank if none):') || '';
      const startSign = (name, action) => {
        if(!name) return;
        const prev = lastActionFor(name)?.action || null;
        if(prev === action){ window.alert(name+' is already '+action+'.'); return; }
        const st = staff.find(s=>s.name===name);
        if(settings.requirePIN && (st?.pin||'').trim()){
          const entered = promptPIN(name);
          if(entered !== st.pin){ window.alert('Incorrect PIN'); return; }
        }
        addRecordInternal(name, action);
      };

      const adminLogin = (name) => {
        if(!name) return;
        const st = staff.find(s=>s.name===name);
        const required = (st?.pin||'').trim().length>0;
        const entered = required ? promptPIN(name) : '';
        if(required && entered !== st.pin){ window.alert('Incorrect PIN'); return; }
        setAdmin({enabled:true, by:name});
      };

      const addStaff = (name) => {
        const clean = (name||'').trim(); if(!clean) return;
        if(staff.some(s=>s.name===clean)){ window.alert('That name already exists.'); return; }
        setStaff(s=> [...s, {name:clean, pin:''}].sort((a,b)=>a.name.localeCompare(b.name)));
      };
      const setPIN = (name) => {
        const st = staff.find(s=>s.name===name);
        const val = window.prompt('Set PIN for '+name+' (leave blank to clear):', st?.pin || '');
        if(val===null) return;
        setStaff(arr => arr.map(x=> x.name===name ? {...x, pin: (val||'').trim()} : x));
      };
      const removeStaff = (name) => {
        if(!window.confirm('Remove '+name+'? This won’t delete past records.')) return;
        setStaff(s=> s.filter(x=>x.name!==name));
        if(selected===name) setSelected('');
      };

      const saveEdit = (recId) => {
        const rec = records.find(r=>r.id===recId); if(!rec) return;
        const newAction = window.prompt('Action (IN or OUT):', rec.action) || rec.action;
        const isoDefault = new Date(rec.ts); isoDefault.setMinutes(isoDefault.getMinutes()-isoDefault.getTimezoneOffset());
        const newIso = window.prompt('Local date/time (YYYY-MM-DDTHH:mm):', isoDefault.toISOString().slice(0,16)) || isoDefault.toISOString().slice(0,16);
        const ts = new Date(newIso).getTime(); if(isNaN(ts)){ window.alert('Invalid date/time'); return; }
        let reason = '';
        if(settings.requireEditReason){
          reason = window.prompt('Reason for edit:','') || '';
          if(!reason.trim()){ window.alert('Reason is required'); return; }
        }
        const old = {...rec};
        setRecords(r=> r.map(x=> x.id===recId ? {...x, action:newAction==='OUT'?'OUT':'IN', ts} : x));
        setAudit(a=> [...a, {id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())+'_'+Math.random()), when:Date.now(), editor:admin.by, type:'EDIT', recordId:recId, targetName:rec.name, reason, oldTs:old.ts, newTs:ts, oldAction:old.action, newAction:newAction==='OUT'?'OUT':'IN'}]);
      };

      const addBackdatedOut = () => {
        const name = window.prompt('Backdate OUT for who (exact name)?','') || '';
        if(!name) return;
        const dt = window.prompt('Enter date/time (YYYY-MM-DDTHH:mm, local):','') || '';
        const ts = new Date(dt).getTime(); if(isNaN(ts)){ window.alert('Invalid date/time'); return; }
        let reason='';
        if(settings.requireEditReason){
          reason = window.prompt('Reason for backdated OUT:','') || '';
          if(!reason.trim()){ window.alert('Reason is required'); return; }
        }
        addRecordInternal(name, 'OUT', ts);
        setAudit(a=> [...a, {id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())+'_'+Math.random()), when:Date.now(), editor:admin.by, type:'ADD_BACKDATED_OUT', targetName:name, reason}]);
      };

      function csvSafe(s){ const q='"'; if(s==null) return ''; const str=String(s); if(/[",\n]/.test(str)) return q+str.replace(/"/g,'""')+q; return str; }
      function dateFileSafe(d){ const p=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate()); }
      function downloadBlob(blob, filename){ try{ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }catch(e){ console.error(e); } }

      const exportCSV = () => {
        const header = ['ID','Name','Action','Timestamp','LocalTime ('+settings.timezone+')'].join(',');
        const lines = records.map(r=> [r.id,csvSafe(r.name),r.action,new Date(r.ts).toISOString(),csvSafe(formatTs(r.ts))].join(','));
        const csv = [header, ...lines].join('\n');
        downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}), 'signio_records_'+dateFileSafe(new Date())+'.csv');
      };
      const exportAuditCSV = () => {
        const header = ['AuditID','WhenISO','Editor','Type','RecordID','TargetName','OldAction','NewAction','OldTsISO','NewTsISO','Reason'].join(',');
        const lines = audit.map(a=> [a.id,new Date(a.when).toISOString(),csvSafe(a.editor),a.type,a.recordId||'',csvSafe(a.targetName||''),a.oldAction||'',a.newAction||'',a.oldTs?new Date(a.oldTs).toISOString():'',a.newTs?new Date(a.newTs).toISOString():'',csvSafe(a.reason||'')].join(','));
        const csv = [header, ...lines].join('\n');
        downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}), 'signio_audit_'+dateFileSafe(new Date())+'.csv');
      };

      const clearAll = () => { if(!confirmClear){ setConfirmClear(true); return; } setRecords([]); setAudit([]); setConfirmClear(false); };

      // Intervals
      function buildIntervalsByPerson(recs){
        const by = new Map(); for(const s of staff) by.set(s.name, []);
        const sorted = [...recs].sort((a,b)=> a.ts-b.ts);
        const open = new Map();
        for(const r of sorted){
          if(r.action==='IN') open.set(r.name, r.ts);
          else if(r.action==='OUT'){
            const start = open.get(r.name);
            if(start!=null && r.ts > start){
              by.get(r.name)?.push([start, r.ts]);
              open.delete(r.name);
            }
          }
        }
        const now = Date.now();
        for(const [name,start] of open.entries()){
          by.get(name)?.push([start, now]);
        }
        return by;
      }
      function overlapMs(aStart, aEnd, bStart, bEnd){
        const start = Math.max(aStart, bStart);
        const end = Math.min(aEnd, bEnd);
        return Math.max(0, end - start);
      }

      // --- Daily totals (per person) ---
      const dailyTotals = useMemo(()=>{
        if(!dailyDate) return [];
        const start = new Date(dailyDate); start.setHours(0,0,0,0);
        const end = new Date(dailyDate); end.setHours(23,59,59,999);
        const intervals = buildIntervalsByPerson(records);
        const rows = [];
        for(const [name,segs] of intervals.entries()){
          let ms = 0;
          for(const [a,b] of segs) ms += overlapMs(a,b,start.getTime(),end.getTime());
          const key = name+'|'+dateFmt.format(start);
          if(overrides[key]!=null && overrides[key] !== ''){
            rows.push({name, hours:+(+overrides[key]).toFixed(2), overridden:true});
          } else if(ms>0) {
            rows.push({name, hours:+(ms/3600000).toFixed(2), overridden:false});
          }
        }
        return rows.sort((a,b)=> a.name.localeCompare(b.name));
      }, [dailyDate, records, staff, overrides]);

      function setOverride(name, dateISO, hours){
        const k = name+'|'+dateISO;
        const val = (hours===''? '' : +(+hours).toFixed(2));
        const next = {...overrides, [k]: val};
        if(val==='' || isNaN(val)) delete next[k];
        setOverrides(next);
        setAudit(a=> [...a, {id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())+'_'+Math.random()), when:Date.now(), editor:admin.by||'ADMIN', type:'SET_DAILY_OVERRIDE', targetName:name, reason:'Manual daily hours override', newTs:undefined, oldTs:undefined}]);
      }

      // --- Range report (per person) + per-day breakdown ---
      function generateRangeReport(){
        if(!rangeStart || !rangeEnd){ setReport({rows:[], perDay:[], start:'', end:''}); return; }
        const s = new Date(rangeStart); s.setHours(0,0,0,0);
        const e = new Date(rangeEnd); e.setHours(23,59,59,999);
        const start = s.getTime(), end = e.getTime();
        const intervals = buildIntervalsByPerson(records);
        const rows = [];
        // Build per-day map applying overrides
        const days = [];
        let d = start;
        while(d <= end){
          const dEnd = localEndOfDay(d);
          const dateIso = dateFmt.format(new Date(d));
          const obj = [];
          for(const [name, segs] of intervals.entries()){
            let ms = 0;
            for(const [a,b] of segs) ms += overlapMs(a,b,d,dEnd);
            let hours = ms/3600000;
            const ov = overrides[name+'|'+dateIso];
            if(ov!=null && ov!=='') hours = +ov;
            if(hours>0) obj.push([name, +hours.toFixed(2)]);
          }
          if(obj.length>0) days.push({ date: dateIso, entries: obj.sort((a,b)=> a[0].localeCompare(b[0])) });
          const nx = new Date(d); nx.setDate(nx.getDate()+1); d = nx.getTime();
        }
        // Accumulate per person from per-day (so overrides are applied)
        const agg = new Map();
        for(const day of days){
          for(const [n,h] of day.entries){
            agg.set(n, (agg.get(n)||0)+h);
          }
        }
        for(const [n, h] of agg.entries()){
          rows.push({ name:n, hours:+h.toFixed(2) });
        }
        rows.sort((a,b)=> a.name.localeCompare(b.name));
        setReport({ rows, perDay: days, start: rangeStart, end: rangeEnd });
      }

      // Export range report CSV (per person)
      function exportRangeCSV(){
        if(!report.rows || report.rows.length===0){ window.alert('Generate the report first.'); return; }
        const header = ['Name','Total hours ('+report.start+' to '+report.end+')'].join(',');
        const lines = report.rows.map(r=> [csvSafe(r.name), r.hours.toFixed(2)].join(','));
        const csv = [header, ...lines].join('\n');
        downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}), 'hours_'+report.start+'_to_'+report.end+'.csv');
      }

      // --- Individual detailed report ---
      function generateIndividual(){
        if(!person){ window.alert('Choose a staff member.'); return; }
        if(!rangeStart || !rangeEnd){ window.alert('Choose start and end dates.'); return; }
        const s = new Date(rangeStart); s.setHours(0,0,0,0);
        const e = new Date(rangeEnd); e.setHours(23,59,59,999);
        const start = s.getTime(), end = e.getTime();
        // Collect this person's records in range (plus bordering for pairing)
        const recs = records.filter(r=> r.name===person && r.ts <= end && r.ts >= (start - 86400000)); // small buffer
        recs.sort((a,b)=>a.ts-b.ts);
        // Build per-day rows: date, pairs, daily total (apply override), running total
        const out = [];
        let grand = 0;
        // Build all intervals for this person using global logic (clip to days)
        const intervals = buildIntervalsByPerson(records).get(person) || [];
        let d = start;
        while(d <= end){
          const dEnd = localEndOfDay(d);
          const dateIso = dateFmt.format(new Date(d));
          const pairs = [];
          for(const [a,b] of intervals){
            const ms = overlapMs(a,b,d,dEnd);
            if(ms>0){
              // Clip in/out to this day when formatting
              const inTs = Math.max(a, d);
              const outTs = Math.min(b, dEnd);
              pairs.push([formatTs(inTs), formatTs(outTs)]);
            }
          }
          // compute hours and apply override
          let msTot = 0;
          for(const [a,b] of intervals) msTot += overlapMs(a,b,d,dEnd);
          let hours = msTot/3600000;
          const ov = overrides[person+'|'+dateIso];
          const overridden = (ov!=null && ov!=='');
          if(overridden) hours = +ov;
          if(pairs.length>0 || overridden || hours>0){
            grand += hours;
            out.push({date:dateIso, pairs, hours:+hours.toFixed(2), overridden});
          }
          const nx = new Date(d); nx.setDate(nx.getDate()+1); d = nx.getTime();
        }
        setIndivRows(out);
        setIndivTotal(+grand.toFixed(2));
      }

      function exportIndividualCSV(){
        if(!person || indivRows.length===0){ window.alert('Generate the individual report first.'); return; }
        const header = ['Staff','Date','Sign in','Sign out','Daily hours','Overridden?'];
        const lines = [];
        for(const row of indivRows){
          if(row.pairs.length===0){
            lines.push([csvSafe(person), row.date, '', '', row.hours.toFixed(2), row.overridden?'YES':'NO'].join(','));
          } else {
            for(const [i,o] of row.pairs){
              lines.push([csvSafe(person), row.date, i, o, row.hours.toFixed(2), row.overridden?'YES':'NO'].join(','));
            }
          }
        }
        lines.push(['TOTAL', '', '', '', indivTotal.toFixed(2), ''].join(','));
        const csv = [header.join(','), ...lines].join('\n');
        downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}), 'hours_'+person+'_'+rangeStart+'_to_'+rangeEnd+'.csv');
      }

      // Today quick view
      const todayTotals = useMemo(()=>{
        const key = todayKey();
        const todays = records.filter(r=> dayKey(r.ts)===key);
        const by = new Map(); for(const s of staff) by.set(s.name, []);
        for(const r of todays) by.get(r.name)?.push(r);
        const res = [];
        const endNow = Date.now();
        for(const [name, recs] of by){
          recs.sort((a,b)=>a.ts-b.ts);
          let ms=0;
          for(let i=0;i<recs.length;i++){
            if(recs[i].action==='IN'){
              const out = recs.slice(i+1).find(x=>x.action==='OUT');
              const outTs = out? out.ts : endNow;
              ms += Math.max(0, outTs - recs[i].ts);
            }
          }
          if(ms>0) res.push({name, hours:+(ms/3600000).toFixed(2)});
        }
        return res.sort((a,b)=>a.name.localeCompare(b.name));
      }, [records, staff, settings.timezone]);

      const el = React.createElement;
      const nameInputRef = useRef(null);
      const [newName, setNewName] = useState('');

      return el('div', {className:'min-h-screen w-full bg-slate-50 text-slate-900 touch-manipulation'},
        // Header
        el('header', {className:'sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200 px-4 py-3 flex items-center justify-between'},
          el('div', {className:'flex items-center gap-3'},
            el('span', {className:'inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-emerald-100 text-emerald-600 font-bold select-none'}, 'IO'),
            el('h1', {className:'text-xl font-semibold'}, 'Staff Sign In / Out'),
            el('span', {className:'ml-2 text-sm text-slate-500'}, settings.timezone)
          ),
          el('div', {className:'flex items-center gap-2'},
            admin.enabled ? [
              el('span', {key:'adm', className:'text-xs text-emerald-700 bg-emerald-100 rounded-full px-2 py-1 select-none'}, 'Admin: '+admin.by),
              el('button', {key:'exit', onClick:()=>setAdmin({enabled:false, by:''}), className:'rounded-xl px-3 py-2 text-sm border'}, 'Exit Admin')
            ] : el('select', {onChange:(e)=> adminLogin(e.target.value), defaultValue:'', className:'rounded-xl border px-2 py-2 text-sm'},
                el('option', {value:'', disabled:true}, 'Admin login…'),
                ...adminOptions.map(n=> el('option', {key:n, value:n}, n))
            ),
            el('button', {onClick: exportCSV, className:'rounded-xl px-3 py-2 text-sm bg-slate-900 text-white hover:bg-slate-800'}, 'Export CSV'),
            el('button', {onClick: exportAuditCSV, className:'rounded-xl px-3 py-2 text-sm border'}, 'Export Audit'),
            el('button', {onClick: ()=> setSettings(s=>({...s, compactRows: !s.compactRows})), className:'rounded-xl px-3 py-2 text-sm border'}, settings.compactRows? 'Comfortable rows':'Compact rows'),
            el('button', {onClick: ()=> setSettings(s=>({...s, show24h: !s.show24h})), className:'rounded-xl px-3 py-2 text-sm border'}, settings.show24h? '12‑hour':'24‑hour'),
            el('button', {onClick: ()=> window.print(), className:'rounded-2xl px-3 py-2 text-sm border hide-on-print'}, 'Print')
          )
        ),
        // Main
        el('main', {className:'mx-auto max-w-6xl p-4 grid lg:grid-cols-3 gap-6'},
          // Left: Kiosk and Today
          el('section', {className:'bg-white rounded-2xl shadow-sm border p-4 lg:col-span-2'},
            el('h2', {className:'text-lg font-semibold mb-3 select-none'}, 'Kiosk'),
            el('div', {className:'flex gap-2 mb-3'},
              el('input', {value:filter, onChange:e=>setFilter(e.target.value), placeholder:'Search staff', className:'w-full rounded-xl border px-3 py-3 text-base'}),
              el('button', {onClick:()=>setFilter(''), className:'rounded-xl border px-3 text-base'}, 'Clear')
            ),
            el('div', {className:'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-4'},
              ...visibleStaff.map(s=> el('button', {key:s.name, onClick:()=>setSelected(s.name), className:'rounded-2xl px-4 py-4 border text-left hover:border-emerald-400 hover:bg-emerald-50 text-base '+(selected===s.name?'border-emerald-500 bg-emerald-50':'')},
                el('div', {className:'font-medium'}, s.name),
                el('div', {className:'text-xs text-slate-500'}, 'Last: '+(lastActionFor(s.name)?.action || '—'))
              ))
            ),
            el('div', {className:'rounded-2xl border p-4 flex flex-col md:flex-row items-center gap-3 select-none'},
              el('div', {className:'flex-1'},
                el('div', {className:'text-sm text-slate-500'}, 'Selected'),
                el('div', {className:'text-xl font-semibold'}, selected || '—')
              ),
              el('div', {className:'flex gap-3'},
                el('button', {disabled:!selected, onClick:()=>startSign(selected,'IN'), className:'rounded-2xl px-8 py-4 bg-emerald-600 text-white disabled:opacity-40 hover:bg-emerald-700 text-lg font-semibold'}, 'Sign In'),
                el('button', {disabled:!selected, onClick:()=>startSign(selected,'OUT'), className:'rounded-2xl px-8 py-4 bg-slate-900 text-white disabled:opacity-40 hover:bg-slate-800 text-lg font-semibold'}, 'Sign Out')
              )
            ),
            // Today totals
            el('div', {className:'mt-4 rounded-xl bg-slate-50 border p-3'},
              el('div', {className:'font-medium mb-2'}, 'Today totals (per person)'),
              todayTotals.length===0 ? el('div', {className:'text-sm text-slate-500'}, 'No hours yet today.') :
              el('table', {className:'w-full text-sm'},
                el('thead', {className:'bg-slate-100'},
                  el('tr', null, el('th', {className:'text-left px-2 py-1'}, 'Name'), el('th', {className:'text-left px-2 py-1'}, 'Hours'))
                ),
                el('tbody', null, ...todayTotals.map(t=> el('tr', {key:t.name, className:'border-t'},
                  el('td', {className:'px-2 py-1'}, t.name),
                  el('td', {className:'px-2 py-1'}, t.hours.toFixed(2))
                )))
              )
            )
          ),
          // Right: Admin/Reports
          el('section', {className:'bg-white rounded-2xl shadow-sm border p-4 lg:col-span-1'},
            el('h2', {className:'text-lg font-semibold mb-3 select-none'}, 'Staff, Settings & Reports'),
            el('div', {className:'flex flex-col gap-3 mb-4'},
              el('div', {className:'flex gap-2'},
                el('input', {ref:(r)=>nameInputRef.current=r, value:newName, onChange:e=>setNewName(e.target.value), placeholder:'Add staff name', className:'flex-1 rounded-xl border px-3 py-3 text-base'}),
                el('button', {onClick:()=>{addStaff(newName); setNewName(''); if(nameInputRef.current) nameInputRef.current.focus();}, className:'rounded-xl px-3 py-3 bg-slate-900 text-white hover:bg-slate-800 text-base'}, 'Add')
              ),
              el('div', {className:'flex flex-col gap-2 max-h-52 overflow-auto pr-1'},
                ...staff.map(s=> el('div', {key:s.name, className:'flex items-center justify-between gap-2 px-3 py-2 rounded-2xl border'},
                  el('div', null,
                    el('div', {className:'font-medium'}, s.name),
                    el('div', {className:'text-xs text-slate-500'}, 'PIN: '+(s.pin ? '••••' : 'not set'))
                  ),
                  admin.enabled && el('div', {className:'flex items-center gap-2'},
                    el('button', {onClick:()=>setPIN(s.name), className:'rounded-xl px-2 py-2 text-xs border'}, 'Set PIN'),
                    el('button', {onClick:()=>removeStaff(s.name), className:'text-xs text-red-600 hover:underline'}, 'remove')
                  )
                ))
              ),
              admin.enabled && [
                el('div', {key:'tz', className:'flex items-center gap-2'},
                  el('label', {className:'text-sm text-slate-600'}, 'Timezone'),
                  el('select', {value:settings.timezone, onChange:e=>setSettings(s=>({...s, timezone:e.target.value})), className:'rounded-xl border px-3 py-2'},
                    el('option', null, 'Australia/Sydney'),
                    el('option', null, 'Australia/Brisbane'),
                    el('option', null, 'Australia/Melbourne'),
                    el('option', null, 'Australia/Perth'),
                    el('option', null, 'Australia/Adelaide')
                  )
                ),
                el('div', {key:'tog', className:'flex items-center gap-3'},
                  el('label', {className:'text-sm text-slate-600 flex items-center gap-2 select-none'},
                    el('input', {type:'checkbox', checked:settings.autoMidnightOut, onChange:e=>setSettings(s=>({...s, autoMidnightOut:e.target.checked}))}),
                    'Auto sign‑out at midnight'
                  ),
                  el('label', {className:'text-sm text-slate-600 flex items-center gap-2 select-none'},
                    el('input', {type:'checkbox', checked:settings.requireEditReason, onChange:e=>setSettings(s=>({...s, requireEditReason:e.target.checked}))}),
                    'Require reason for edits'
                  )
                ),
                // Daily totals (per person) with overrides
                el('div', {key:'daily', className:'rounded-2xl border p-3 bg-slate-50'},
                  el('div', {className:'font-medium mb-2'}, 'Daily totals (per person) — with admin override'),
                  el('input', {type:'date', value:dailyDate, onChange:e=>setDailyDate(e.target.value), className:'rounded-xl border px-3 py-2 mb-2'}),
                  dailyTotals.length===0 ? el('div', {className:'text-sm text-slate-500'}, 'No hours for this date.') :
                  el('table', {className:'w-full text-sm'},
                    el('thead', {className:'bg-slate-100'},
                      el('tr', null, 
                        el('th', {className:'text-left px-2 py-1'}, 'Name'), 
                        el('th', {className:'text-left px-2 py-1'}, 'Hours'),
                        el('th', {className:'text-left px-2 py-1'}, 'Override')
                      )
                    ),
                    el('tbody', null, ...dailyTotals.map(t=> el('tr', {key:t.name, className:'border-t'},
                      el('td', {className:'px-2 py-1'}, t.name),
                      el('td', {className:'px-2 py-1'}, (t.overridden?'* ':'') + t.hours.toFixed(2)),
                      el('td', {className:'px-2 py-1'}, 
                        el('input', {type:'number', step:'0.01', min:'0', placeholder:'hrs', className:'w-24 rounded border px-2 py-1', 
                          onChange:(e)=>{}, 
                          onBlur:(e)=> setOverride(t.name, dailyDate, e.target.value)
                        })
                      )
                    )))
                  ),
                ),
                // Range report
                el('div', {key:'reports', className:'rounded-2xl border p-3 bg-slate-50'},
                  el('div', {className:'font-medium mb-2'}, 'Hours report (per person)'),
                  el('div', {className:'grid grid-cols-1 gap-2'},
                    el('label', {className:'text-sm'}, 'Start date'),
                    el('input', {type:'date', value:rangeStart, onChange:e=>setRangeStart(e.target.value), className:'rounded-xl border px-3 py-2'}),
                    el('label', {className:'text-sm'}, 'End date'),
                    el('input', {type:'date', value:rangeEnd, onChange:e=>setRangeEnd(e.target.value), className:'rounded-xl border px-3 py-2'}),
                    el('div', {className:'flex gap-2'},
                      el('button', {onClick:generateRangeReport, className:'rounded-xl bg-emerald-600 text-white px-3 py-2 hover:bg-emerald-700'}, 'Generate'),
                      el('button', {onClick:exportRangeCSV, className:'rounded-xl border px-3 py-2'}, 'Export CSV'),
                      el('button', {onClick:()=>window.print(), className:'rounded-xl border px-3 py-2'}, 'Print report')
                    )
                  ),
                  el('div', {id:'printable-report', className:'mt-3 bg-white border rounded-xl p-3'},
                    report.rows.length===0 ? el('div', {className:'text-sm text-slate-500'}, 'No report yet.') :
                    el('div', null,
                      el('div', {className:'text-sm text-slate-600 mb-2'}, 'Report: '+report.start+' → '+report.end),
                      el('table', {className:'w-full text-sm'},
                        el('thead', {className:'bg-slate-100'},
                          el('tr', null,
                            el('th', {className:'text-left px-2 py-1'}, 'Name'),
                            el('th', {className:'text-left px-2 py-1'}, 'Total hours')
                          )
                        ),
                        el('tbody', null,
                          ...report.rows.map(r=> el('tr', {key:r.name, className:'border-t'},
                            el('td', {className:'px-2 py-1'}, r.name),
                            el('td', {className:'px-2 py-1'}, r.hours.toFixed(2))
                          ))
                        )
                      ),
                      el('div', {className:'mt-3'},
                        el('div', {className:'font-medium mb-1'}, 'Per-day breakdown'),
                        ...report.perDay.map(d=> el('div', {key:d.date, className:'rounded-xl border bg-white p-2 mb-2'},
                          el('div', {className:'text-sm font-semibold mb-1'}, d.date),
                          el('table', {className:'w-full text-sm'},
                            el('tbody', null,
                              ...d.entries.map(function(item){
                                return el('tr', {key:item[0]},
                                  el('td', {className:'px-2 py-1 w-1/2'}, item[0]),
                                  el('td', {className:'px-2 py-1'}, Number(item[1]).toFixed(2))
                                );
                              })
                            )
                          )
                        ))
                      )
                    )
                  )
                ),
                // Individual detailed report
                el('div', {key:'individual', className:'rounded-2xl border p-3 bg-slate-50'},
                  el('div', {className:'font-medium mb-2'}, 'Individual detailed report'),
                  el('div', {className:'grid grid-cols-1 gap-2'},
                    el('label', {className:'text-sm'}, 'Staff member'),
                    el('select', {value:person, onChange:e=>setPerson(e.target.value), className:'rounded-xl border px-3 py-2'},
                      el('option', {value:''}, 'Select…'),
                      ...staff.map(s=> el('option', {key:s.name, value:s.name}, s.name))
                    ),
                    el('label', {className:'text-sm'}, 'Start date'),
                    el('input', {type:'date', value:rangeStart, onChange:e=>setRangeStart(e.target.value), className:'rounded-xl border px-3 py-2'}),
                    el('label', {className:'text-sm'}, 'End date'),
                    el('input', {type:'date', value:rangeEnd, onChange:e=>setRangeEnd(e.target.value), className:'rounded-xl border px-3 py-2'}),
                    el('div', {className:'flex gap-2'},
                      el('button', {onClick:generateIndividual, className:'rounded-xl bg-emerald-600 text-white px-3 py-2 hover:bg-emerald-700'}, 'Generate'),
                      el('button', {onClick:exportIndividualCSV, className:'rounded-xl border px-3 py-2'}, 'Export CSV'),
                      el('button', {onClick:()=>window.print(), className:'rounded-xl border px-3 py-2'}, 'Print')
                    )
                  ),
                  el('div', {id:'printable-individual', className:'mt-3 bg-white border rounded-xl p-3'},
                    indivRows.length===0 ? el('div', {className:'text-sm text-slate-500'}, 'No report yet.') :
                    el('div', null,
                      el('div', {className:'text-sm text-slate-600 mb-2'}, 'Report for '+person+': '+rangeStart+' → '+rangeEnd),
                      el('table', {className:'w-full text-sm'},
                        el('thead', {className:'bg-slate-100'},
                          el('tr', null,
                            el('th', {className:'text-left px-2 py-1'}, 'Date'),
                            el('th', {className:'text-left px-2 py-1'}, 'Sign in'),
                            el('th', {className:'text-left px-2 py-1'}, 'Sign out'),
                            el('th', {className:'text-left px-2 py-1'}, 'Daily hours')
                          )
                        ),
                        el('tbody', null,
                          ...indivRows.flatMap(row=>{
                            if(row.pairs.length===0){
                              return [el('tr', {key:row.date, className:'border-t'},
                                el('td', {className:'px-2 py-1'}, row.date),
                                el('td', {className:'px-2 py-1'}, ''),
                                el('td', {className:'px-2 py-1'}, ''),
                                el('td', {className:'px-2 py-1'}, (row.overridden?'* ':'') + row.hours.toFixed(2))
                              )];
                            }
                            return row.pairs.map((p,idx)=> el('tr', {key:row.date+'_'+idx, className:'border-t'},
                              el('td', {className:'px-2 py-1'}, idx===0? row.date : ''),
                              el('td', {className:'px-2 py-1'}, p[0]),
                              el('td', {className:'px-2 py-1'}, p[1]),
                              el('td', {className:'px-2 py-1'}, idx===0? (row.overridden?'* ':'') + row.hours.toFixed(2) : '')
                            ));
                          })
                        )
                      ),
                      el('div', {className:'text-right font-semibold mt-2'}, 'Total hours: '+indivTotal.toFixed(2)),
                      el('div', {className:'text-xs text-slate-500 mt-1'}, '* = Admin override applied')
                    )
                  )
                ),
                el('div', {key:'clear', className:'flex items-center gap-2 mt-2'},
                  el('button', {onClick:clearAll, className:'rounded-xl px-3 py-2 border'}, confirmClear? 'Click again to confirm – Clear ALL records' : 'Clear ALL records'),
                  confirmClear && el('button', {onClick:()=>{setConfirmClear(false);}, className:'rounded-xl px-3 py-2 border'}, 'Cancel')
                )
              ],
              el('h3', {className:'text-base font-semibold mb-2 select-none'}, 'Currently IN'),
              el('div', {className:'rounded-2xl border p-3 min-h-[3rem] bg-slate-50'},
                currentlyIn.length===0 ? el('div', {className:'text-sm text-slate-500'}, 'No one is signed in.')
                : el('ul', {className:'text-sm flex flex-wrap gap-2'}, ...currentlyIn.map(n=> el('li', {key:n, className:'inline-flex items-center px-2 py-1 rounded-xl bg-emerald-100 text-emerald-700'}, n)))
              )
            )
          )
        ),
        // Records table
        el('section', {className:'bg-white rounded-2xl shadow-sm border p-4 lg:col-span-3'},
          el('h3', {className:'text-base font-semibold mb-2 select-none'}, 'Recent Activity'),
          el('div', {className:'overflow-auto border rounded-2xl'},
            el('table', {className:'w-full text-sm'},
              el('thead', {className:'bg-slate-50'},
                el('tr', {className:'text-left'},
                  el('th', {className:'px-3 py-2'}, 'When'),
                  el('th', {className:'px-3 py-2'}, 'Name'),
                  el('th', {className:'px-3 py-2'}, 'Action'),
                  el('th', {className:'px-3 py-2 w-24'}, admin.enabled ? 'Edit' : '')
                )
              ),
              el('tbody', {className: settings.compactRows? '' : 'text-[0.95rem]'},
                ...[...records].reverse().slice(0,500).map(r=> el('tr', {key:r.id, className:'border-t'},
                  el('td', {className:'px-3 py-2 whitespace-nowrap'}, formatTs(r.ts)),
                  el('td', {className:'px-3 py-2'}, r.name),
                  el('td', {className:'px-3 py-2'}, el('span', {className:'inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold '+(r.action==='IN'?'bg-emerald-100 text-emerald-700':'bg-slate-200 text-slate-800')}, r.action)),
                  el('td', {className:'px-3 py-2'}, admin.enabled && el('button', {onClick:()=>saveEdit(r.id), className:'rounded-xl border px-2 py-1 text-xs'}, 'Edit'))
                )),
                records.length===0 ? el('tr', null, el('td', {className:'px-3 py-4 text-slate-500', colSpan:4}, 'No records yet. Select a staff member and tap Sign In / Sign Out.')) : null
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
